let Fs=require("fire-fs");const FsExtra=require("fs-extra");let Path=require("fire-path");const{debounce:debounce}=require("lodash");Editor.require("packages://bitmap-font/panel-ttf/core/index");let UUID=Editor.require("packages://bitmap-font/node_modules/uuid");const SvgJs=require("svg.js");Editor.Panel.extend({style:Fs.readFileSync(Editor.url("packages://bitmap-font/panel-ttf/index.css"),"utf8"),template:Fs.readFileSync(Editor.url("packages://bitmap-font/panel-ttf/index.html"),"utf8"),ready(){let e=new window.Vue({el:this.shadowRoot,profile:null,created(){Editor.Profile.load("profile://project/bmfont-ttf.json",(e,t)=>{if(e);else{this.profile=t,this.saveName=t.data.saveName,this.savePath=t.data.savePath,this.space=t.data.space||1,t.data.canvasBgColor&&(this.canvasBgColor=cc.color(t.data.canvasBgColor));let e=t.data.fontColor;e&&(this.font.color=cc.color(e)),this.font.size=t.data.fontSize||50,this.font.string=t.data.fontString||"6",this.font.file=t.data.fontFile,Fs.existsSync(this.font.file)||(this.font.file=this.profile.fontFile=null,this.profile.save()),this.texture.file=t.data.textureFile,this.texture.file&&Fs.existsSync(this.texture.file)||(this.texture.file=null,this.profile.save())}}),this._loadContextBlenderScript()},compiled(){FontEngine.initEngine(this.$els.canvas),FontEngine.selectFontCB=(e=>{if(e){let t=e.string.charCodeAt(0),i=`字符:${e.string}, ASCII:${t}, x:${e.x}, y:${e.y}, width:${e.width}, height:${e.height}`;this.tipFont=i}else this.tipFont=""}),FontEngine.updateTextureCB=(()=>{this.updateTipTexture()}),this.updateFontRender(),this.font.file&&this._useFont(this.font.file),this.texture.file&&FontEngine.setTextureImageData(this.texture.file)},data:{tipFont:null,tipTexture1:null,tipTexture2:null,curUseLetter:null,commonUseLetters:[{id:1,name:"数字",letter:"0123456789"},{id:2,name:"数字标点",letter:"0123456789/*-+."}],savePath:null,saveName:"bitmap",space:5,canvasBgColor:cc.Color.GRAY,font:{file:null,name:"test",size:100,string:"4",color:cc.Color.GREEN},outline:{enable:!1,color:cc.Color.BLACK,width:1},gradual:{enable:!1,direction:FontEngine.GradualDirection.Up2Down.value,start:cc.Color.WHITE,end:cc.Color.BLUE},directions:FontEngine.GradualDirection,shadow:{enable:!1,offset:cc.v2(0,0),color:cc.Color.RED,dim:1},texture:{enable:!1,file:null}},methods:{onChangeCommonUseLetter(e){let t=e.currentTarget.value;this.curUseLetter=t;let i=null;this.commonUseLetters.forEach(e=>{e.id.toString()===t.toString()&&(i=e.letter)}),i&&(this.font.string=this._filterSameLetter(i),this.updateFontRender())},updateFontRender(){if(FontEngine.syncFonts(this.$data),FontEngine.update(),this.profile){let e=this.canvasBgColor,t=cc.color(e.r,e.g,e.b,e.a);this.profile.data.canvasBgColor=t.toCSS("#rrggbbaa");let i=this.font.color,o=cc.color(i.r,i.g,i.b,i.a);this.profile.data.fontColor=o.toCSS("#rrggbbaa"),this.profile.data.fontFile=this.font.file,this.profile.data.fontSize=this.font.size,this.profile.data.space=this.space,this.profile.data.fontString=this.font.string,this.profile.data.textureFile=this.texture.file,this.profile.save()}},onChangeBgColor(){},onChangeFontSize(){},onClickSaveFnt(){this.saveName&&this.savePath&&(Fs.existsSync(this.savePath)||Fs.ensureDirSync(this.savePath),FontEngine.Save.genBMFont(this.$data))},onChangeText:debounce(()=>{e.updateText()},1e3),_filterSameLetter(e){let t="";for(let i=0;i<e.length;i++){let o=e[i];-1===t.indexOf(o)&&(t+=o)}return t},updateText(){this.curUseLetter=null,this.font.string=this._filterSameLetter(this.font.string),this.updateFontRender()},onClickSelectSavePath(){let e=Editor.Dialog.openFile({title:"选择保存路径",properties:["openDirectory"]});if(-1!==e){let t=e[0];this.savePath=t,this.profile&&(this.profile.data.savePath=t,this.profile.save())}},onChangeSaveName(){this.profile&&(this.profile.data.saveName=this.saveName,this.profile.save())},onClickImportTTF(){let e=Editor.Dialog.openFile({title:"选择字体文件",properties:["openFile"],filters:[{name:"TTF字体",extensions:["ttf"]}]});if(-1!==e){let t=e[0];this._useFont(t)}},onClickSelectTextureFile(){let e=Editor.Dialog.openFile({title:"选择纹理图片",properties:["openFile"],filters:[{name:"图片",extensions:["png","jpg","jpeg"]}]});if(-1!==e){let t=e[0];this._useTexture(t)}},_useTexture(e){Fs.existsSync(e)&&(this.texture.file=e,this.profile&&(this.profile.data.textureFile=e,this.profile.save(),FontEngine.setTextureImageData(e),this.updateTipTexture()))},updateTipTexture(){let e=this.texture.file;let t=Editor.require("packages://bitmap-font/node_modules/image-size")(e),i=FontEngine.getMaxFontSize();this.tipTexture1=`材质图片尺寸:${t.width}x${t.height}`,this.tipTexture2=`建议尺寸:${i.width}x${i.height}`},_useFont(e){if(this._checkFontFileSize(e)){this.font.file=e,this.profile&&(this.profile.data.fontFile=e,this.profile.save());let t=Path.basenameNoExt(e),i=Fs.readFileSync(e),o=`${require("crypto").createHash("md5").update(i).digest("hex")}-${t}`;this.font.name=o,FontEngine.useFont({name:o,url:e})}else Editor.Dialog.messageBox({title:"提示",type:"info",message:"使用的字体文件不能大于30M",buttons:["确定"],defaultId:0})},_checkFontFileSize:e=>!(Fs.statSync(e).size>=31457280),drop(e){e.preventDefault();let t=e.dataTransfer.files;if(t&&t.length>0){let e=t[0];e.path.endsWith(".ttf")||e.path.endsWith(".TTF")?this._useFont(e.path):e.path.endsWith(".png")||e.path.endsWith(".jpg")||e.path.endsWith(".jpeg")?this._useTexture(e.path):Editor.Dialog.messageBox({type:"warning",buttons:["OK"],title:"设置错误",message:`不支持的文件类型:${e.name}`,noLink:!0})}},_tetMSDFBmfont(){Editor.require("packages://bitmap-font/node_modules/msdf-bmfont")(ttfFile,{charset:"0123456789",fieldType:"sdf"},(e,t,i)=>{if(e)throw e;t.forEach((e,t)=>{i.pages.push(`sheet${t}.png`);let o=Path.join(Editor.Project.path,"out",`sheet${t}.png`);FsExtra.ensureFileSync(o),Fs.writeFileSync(o,e)});let o=Path.join(Editor.Project.path,"out","font.json");FsExtra.ensureFileSync(o),Fs.writeFileSync(o,JSON.stringify(i,null,4))})},dragOver(e){e.preventDefault(),e.stopPropagation()},dragEnter(e){e.preventDefault(),e.stopPropagation()},dragLeave(e){e.preventDefault()},_loadContextBlenderScript(){let e=document.createElement("script");e.setAttribute("type","text/javascript"),e.setAttribute("src",Editor.url("packages://bitmap-font/core/context_blender.js")),e.onload=function(){this.parentNode.removeChild(this)},document.body.appendChild(e)}}})}});