const Fs=require("fire-fs"),FsExtra=require("fs-extra"),Path=require("fire-path"),Electron=require("electron");var CfgUtil=Editor.require("packages://bitmap-font/core/CfgUtil");const Msg=Editor.require("packages://bitmap-font/panel/msg.js");var BMPlugin=null;Editor.Panel.extend({style:Fs.readFileSync(Editor.url("packages://bitmap-font/panel/index.css"),"utf8"),template:Fs.readFileSync(Editor.url("packages://bitmap-font/panel/index.html"),"utf8"),ready(){Editor.require("packages://bitmap-font/panel/item/item.js"),BMPlugin=new window.Vue({el:this.shadowRoot,created(){this._initPlugin(),this.$root.$on(Msg.OnLog,t=>{this._addLog(t)})},data:{isLoadCfgProject:!0,uuid:null,logs:[],fileSavePath:null,fileSaveName:null,fileImportPath:null,charDataArray:[],cfgArray:[]},methods:{isShowDropTips(){return this.charDataArray&&0===this.charDataArray.length},onCfgSelectChange(t,e,a){t.currentTarget.value},onBtnClickTest(){let t=Path.join(Editor.projectInfo.path,"packages/bitmap-font/panel/index.js"),e=Path.join(Editor.projectInfo.path,"packages/bitmap-font/panel/index.min.js");if(!Fs.existsSync(t))return void this._addLog("文件不存在: "+t);let a=Fs.readFileSync(t,"utf-8"),i=Editor.require("packages://bitmap-font/node_modules/uglify-es").minify(a);i.error?this._addLog("生成压缩代码失败"):(this._addLog(i.code),Fs.writeFileSync(e,i.code))},_addLog(t){let e=new Date;this.logs+="["+e.toLocaleString()+"]: "+t+"\n",this.$nextTick(()=>{let t=this.$els.log;t&&(t.scrollTop=t.scrollHeight)})},onBtnClickDelAllCharCfg(){0===Editor.Dialog.messageBox({type:"question",title:"提示",message:"确定删除所有?",buttons:["确定","取消"],defaultId:0,noLink:!0,cancelId:1})&&this.delAllCharCfg()},delAllCharCfg(){this.charDataArray.splice(0,this.charDataArray.length),CfgUtil.saveConfig(),this._addLog("清空配置成功!")},delCharCfg(t){if(!t)return void this._addLog("删除失败");let e=!1;for(let a=0;a<this.charDataArray.length;a++){let i=this.charDataArray[a];i.image===t.image&&i.width===t.width&&i.height===t.height&&(this.charDataArray.splice(a,1),this._addLog("删除: "+i.image),e=!0)}e&&CfgUtil.saveConfig()},_initPlugin(){let t=CfgUtil.initCfg();t&&(this.fileSaveName=t.saveName,this.fileSavePath=t.savePath,this.fileImportPath=t.saveImport,this.charDataArray=t.bitMapCfg||[],this.charDataArray.sort((t,e)=>{let a=t.image,i=e.image,r=Path.basename(a),h=Path.basename(i);return r.charCodeAt(0)-h.charCodeAt(0)}),this._initFileSaveDir())},_initFileSaveDir(){if(this.fileSavePath&&Fs.existsSync(this.fileSavePath));else{let t=Path.join(Editor.projectInfo.path,"out/bitmap-font");Fs.existsSync(t)||FsExtra.ensureDirSync(t),this.fileSavePath=t,CfgUtil.setSavePath(t)}},onClickOpen(){this.fileSavePath&&Fs.existsSync(this.fileSavePath)&&(Electron.shell.showItemInFolder(this.fileSavePath),Electron.shell.beep())},onClickSelect(){let t=Editor.projectInfo.path;this.fileSavePath&&Fs.existsSync(this.fileSavePath)&&(t=this.fileSavePath);let e=Editor.Dialog.openFile({title:"选择位图文件保存目录",defaultPath:t,properties:["openDirectory"]});if(-1!==e){let t=e[0];this.fileSavePath=t,CfgUtil.setSavePath(t)}},onUpdateSaveName(t){if(this.fileSaveName){if(0===this.fileSaveName.length)return void this._addLog("保存文件名不能为空");if(new RegExp('^[^\\\\\\/:*?\\"<>|]+$').test(this.fileSaveName)){if(-1!==this.fileSaveName.indexOf(".")){let t=this.fileSaveName.split(".");this._addLog(this.fileSaveName+"不需要包含扩展名,已经自动修改为:"+t[0]),this.fileSaveName=t[0]}CfgUtil.setSaveName(this.fileSaveName)}else this._addLog("文件名不符合规则:"+this.fileSaveName),this.fileSaveName=""}else this._addLog("文件名无效!")},onSelectImportPath(){let t=Editor.Dialog.openFile({title:"选择导出目录",defaultPath:Editor.projectInfo.path,properties:["openDirectory"]});if(-1!==t){let e=t[0],a=Editor.assetdb.remote.fspathToUrl(e);-1===a.indexOf("db://")?(this._addLog("不是项目资源目录:"+e),this.fileImportPath=""):(this.fileImportPath=a,CfgUtil.setSaveImport(a))}},onGenAndImportFont(){Editor.assetdb.queryInfoByUuid(this.uuid,(t,e)=>{if(t)this._addLog(t);else{let t=e.path,a=Path.dirname(t),i=Path.basename(t,".fnt");this.onGen(i,()=>{this._addLog("导入bitmap-font到项目!");let t=Editor.assetdb.remote.fspathToUrl(a);setTimeout(()=>{this.onImport(i,t)},500)})}})},onImportFont(){this.onImport(this.fileSaveName,this.fileImportPath)},onImport(t,e){if(!e)return void this._addLog("导出目录错误:"+e);let a=Path.join(this.fileSavePath,t+".png");if(!Fs.existsSync(a))return void this._addLog("fnt图片文件不存在:"+a);let i=Path.join(this.fileSavePath,t+".fnt");if(!Fs.existsSync(i))return void this._addLog("fnt字体文件不存在:"+i);Editor.assetdb.import([a,i],e,!0,(t,a)=>{this._addLog("导入成功!"),Editor.assetdb.refresh(e),a.forEach((t,e,a)=>{})})},onGen(t,e){if(!this.fileSavePath||!Fs.existsSync(this.fileSavePath))return void this._addLog("文件保存目录不存在: "+this.fileSavePath);let a=this._checkAllCharValueIsSet();if(a)return void this._addLog("该图片没有设置字符: "+a.image);if(this.charDataArray.length<=0)return void this._addLog("请导入图片!");let i=Editor.require("packages://bitmap-font/core/GenBmFont.js");i.checkAllCharIsSameHeight(this.charDataArray)||this._addLog("发现所有字符图片的高度不一致,可能会影响游戏的效果,推荐使用相同高度的字符图片"),this._addLog("生成中..."),i.gen(this.charDataArray,{path:this.fileSavePath,name:t,padding:2},a=>{a?this._addLog(`生成[${t}]失败: ${a.msg}`):(this._addLog(`生成[${t}]成功: ${this.fileSavePath}`),e&&e())})},onClickGen(){this.onGen(this.fileSaveName)},_checkAllCharValueIsSet(){for(let t=0;t<this.charDataArray.length;t++){let e=this.charDataArray[t];if(null===e.char)return e;if(""===e.char)return e}return null},_setCharData(t,e){require("util");let a=null;for(let e=0;e<this.charDataArray.length;e++){let i=this.charDataArray[e];if(i.image===t){a=i.char;break}}if(a&&1===a.length){let t=a.charCodeAt(0),i=e.x,r=e.y,h=e.width;return`char id=${t}   x=${i}    y=${r}     width=${h}    height=${e.height}    xoffset=0     yoffset=0     xadvance=${h}    page=0  chnl=15\n`}return this._addLog("没有发现字符"),null},drop(t){t.preventDefault();try{let e=Editor.UI.DragDrop.items(t.dataTransfer);if(e&&e.length>0){let t=!1,a=!1;for(let i=0;i<e.length;i++){let r=e[i],h=r.assetType||r.type;if("texture"!==h)"image/png"!==h?this._addLog(`不支持的类型:${h}`):(this._dealDropFile(r.path),t=!0);else{this._addLog(`[BM-Font] 不推荐使用资源管理中的位图资源[${r.name}]`);let e=Editor.remote.assetdb.uuidToFspath(r.id);this._dealDropFile(e),t=!0,a=!0}}a&&this._addLog("[BM-Font] 建议把位图资源存放在项目外部, 再使用该工具制作."),t&&(CfgUtil.saveConfig(),this.$nextTick(()=>{this.$root.$emit("OnDropChars")}))}}catch(t){this._addLog("当前使用的creator版本不支持从资源管理器拖拽, 请联系开发者.")}return!1},_dealDropFile(t){if(this._isSameFileExist(t))this._addLog("已经存在该图片: "+t);else{let e=Path.basenameNoExt(t)[0]||null;this._addImage(t,e)}},_addImage(t,e){let a=Editor.require("packages://bitmap-font/node_modules/image-size")(t),i={image:t,char:e,width:a.width,height:a.height};this.charDataArray.push(i),this.charDataArray.sort((t,e)=>{let a=t.image,i=e.image,r=Path.basename(a).toLowerCase(),h=Path.basename(i).toLowerCase(),s=r.length>h.length?h.length:r.length,l=0;for(let t=0;t<s;t++)if(r.charCodeAt(t)!==h.charCodeAt(t)){l=t;break}return r.charCodeAt(l)-h.charCodeAt(l)}),CfgUtil.setBitmapCfg(this.charDataArray)},_isSameFileExist(t){let e=!1;for(let a=0;a<this.charDataArray.length;a++)if(this.charDataArray[a].image===t){e=!0;break}return e},dragOver(t){t.preventDefault(),t.stopPropagation()},dragEnter(t){t.preventDefault(),t.stopPropagation()},dragLeave(t){t.preventDefault()}}})},messages:{onLog(t,e){BMPlugin&&BMPlugin._addLog(e)},onClickDelChar(t,e){BMPlugin&&BMPlugin.delCharCfg(e)},onClickDelAllChar(t,e){BMPlugin&&BMPlugin.delAllCharCfg(e)}}});