let SpriteSmith=Editor.require("packages://bitmap-font/node_modules/spritesmith");const Path=require("fire-path"),Fs=require("fire-fs");module.exports={_getCharImageMaxHeight(e){let t=0;return e.forEach(e=>{e.height>t&&(t=e.height)}),t},checkAllCharIsSameHeight(e){let t=null;for(let i=0;i<e.length;i++){let a=e[i];if(0===i)t=a.height;else if(a.height!==t)return!1}return!0},gen(e,t,i){let a=[];e.forEach(e=>{a.push(e.image)});let r=2;void 0!==t.padding&&(r=t.padding),SpriteSmith.run({src:a,algorithm:"binary-tree",padding:r},(a,r)=>{if(a);else{let a=r.properties.width,h=r.properties.height,n=this._getCharImageMaxHeight(e),l=`info face="${t.face||"face"}" size=${t.fontSize||n}\n`,o=`common lineHeight=${n} scaleW=${a} scaleH=${h} pages=1\n`,g=`page id=0 file="${t.name}.png"\n`,s=`chars count=${e.length}\n`,f="";for(let t in r.coordinates){let a=this._setCharData(t,r.coordinates[t],e);if(!a)return i&&i({msg:`该图片没有设置字符:${t}`});f+=a}let c=l+o+g+s+f,d=Path.join(t.path,`${t.name}.fnt`);Fs.writeFileSync(d,c);let p=Path.join(t.path,`${t.name}.png`);Fs.writeFileSync(p,r.image),i&&i(null)}})},_setCharData(e,t,i){let a=null;for(let t=0;t<i.length;t++){let r=i[t];if(r.image===e){a=r;break}}if(a){let e=a.char.charCodeAt(0),{x:i,y:r,width:h,height:n}=t,l=a.xoffset||0,o=a.yoffset||0,g=h;return void 0!==a.xadvance&&(g=a.xadvance),`char id=${e} x=${i} y=${r} width=${h} height=${n} xoffset=${Math.round(l)} yoffset=${Math.round(o)} xadvance=${Math.round(g)} page=0 chnl=15\n`}return null}};